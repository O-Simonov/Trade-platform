# config/screener_oi.yaml
# ------------------------------------------------------------
# scr_oi_binance — скринер Open Interest на Binance
#
# Основная идея: после «тихой базы» (флэт/снижение + спокойные объёмы)
# ловим импульс по OI + объёму, который подтверждается ценой.
#
# BUY (лонг):
#   1) В базе (base_minutes) цена во флэте или в снижении, и объёмы «тихие»
#   2) В триггере (trigger_minutes) OI растёт (контракты) >= buy_oi_rise_pct
#   3) OI$ (open_interest_value) подтверждает рост >= oi_value_confirm_pct
#   4) Объём «ожил» (по среднему и/или по пику свечи): buy_volume_mult / buy_volume_spike_mult
#   5) Цена растёт >= buy_price_rise_pct, есть зелёные свечи, и (опционально) последняя свеча зелёная
#   6) Funding отрицательный (если enable_funding=true)
#
# SELL (шорт):
#   1) В базе цена во флэте или в снижении, и объёмы «тихие»
#   2) Появляется слабость/разворот: падение цены + откат от локального максимума
#   3) OI падает (за 1 свечу или в окне) и объёмы затухают после всплеска
#   4) Funding положительный (если sell_enable_funding=true)
#
# Результат:
#   - Запись сигнала в таблицу signals (source/status выставляются кодом)
#   - График (цена + объём + OI) с точкой входа, SL/TP и funding в заголовке
#   - Отправка в Telegram (если включено)
#   - Ретеншн графиков: keep_plots_days (по умолчанию 2 дня)
# ------------------------------------------------------------

restart_interval_minutes: 5  # Интервал запуска раннера (мин). Каждые N минут выполняется новый прогон.

screeners:
  - name: scr_oi_binance  # Имя скринера (должно совпадать с registry/классом)
    enabled: true         # true — скринер включён; false — пропускается
    version: "0.1"        # Версия для логов/аудита (меняй при изменении логики)

    params:
      # ==========================================================
      # БАЗОВЫЕ НАСТРОЙКИ
      # ==========================================================
      exchange_id: 1       # ID биржи в БД (у тебя Binance = 1)

      # Таймфреймы:
      # - если указан intervals: ["5m","15m"], скринер выполнится по каждому ТФ отдельно
      # - если intervals не задан, можно использовать interval: "5m"
      intervals: ["5m", "15m"]  # Список таймфреймов для прогона
      # interval: "5m"          # Альтернатива: один таймфрейм (если intervals не задан)

      min_price: 0.0000001  # Минимальная цена (фильтр «пылинок» и мусорных символов)
      max_price: 100000     # Максимальная цена (фильтр аномально дорогих/нецелевых)

      max_symbols: 0        # 0 = без лимита; >0 = ограничить количество символов из БД
      signal_mode: "both"   # both | buy | sell (какие сигналы генерировать)

      # ==========================================================
      # ОКНА АНАЛИЗА (значения по умолчанию, ориентированы на 5m)
      # ==========================================================
      base_minutes: 240     # «База» (фон) в минутах: флэт/снижение (по ТЗ 240 минут)
      trigger_minutes: 20   # «Триггер» в минутах: импульс (по ТЗ 20 минут)

      # ==========================================================
      # ПЕР-ИНТЕРВАЛЬНЫЕ OVERRIDES (разные настройки для 5m/15m/...)
      # ==========================================================
      # Если запускаешь intervals: ["5m","15m"], то параметры ниже позволяют задать
      # индивидуальные пороги/окна для каждого ТФ.
      #
      # Практика:
      # - Временные окна (base_minutes/trigger_minutes/max_signal_age_minutes) для 15m
      #   чаще всего увеличиваем примерно ×3 (потому что 15m свеча = 3 свечи 5m).
      # - Пороги в процентах и мультипликаторы (OI%, price%, volume mult) обычно НЕ умножаем ×3.
      #   Их либо оставляем, либо делаем немного строже для 15m (чтобы сигналы были «качественнее»).
      # - plot_lookback_bars для 15m обычно уменьшаем, чтобы сохранить тот же горизонт по времени.
      per_interval_overrides:
        "5m":
          # Окна и «свежесть»
          base_minutes: 240          # 4 часа базы
          trigger_minutes: 20        # 20 минут триггера
          max_signal_age_minutes: 30 # Свежесть сигнала (мин): старше — не пишем/не шлём
          plot_lookback_bars: 220    # История на графике (в свечах)

          # Пороги BUY (5m) — «живые» стартовые значения
          buy_oi_rise_pct: 0.9       # Рост OI (контракты) в trigger-окне, %
          oi_value_confirm_pct: 0.9  # Рост OI$ (USDT) в trigger-окне, %
          buy_volume_mult: 1.4       # Средний объём trigger >= median(base) * N
          buy_volume_spike_mult: 2.8 # Пик свечи trigger >= median(base) * N
          buy_price_rise_pct: 0.05   # Рост цены в trigger-окне (по «пику»), %
          buy_min_green_candles: 1   # Минимум зелёных свечей в trigger-окне
          buy_require_last_green: true # Последняя свеча trigger-окна должна быть зелёной

          # Пороги SELL (5m)
          sell_oi_drop_one_candle_pct: 0.9 # Падение OI за 1 свечу, %
          sell_oi_drop_window_pct: 0.9     # Падение OI за trigger-окно, %
          sell_price_drop_last_pct: 0.3    # Падение цены на последней свече/в конце окна, %
          sell_reversal_from_max_pct: 0.35 # Откат от локального максимума в trigger-окне, %
          sell_volume_spike_mult: 1.6      # Пик объёма trigger >= median(base) * N
          sell_volume_drop_ratio: 0.7      # Затухание: объём в конце <= peak * ratio

        "15m":
          # Окна и «свежесть» (×3 к 5m — чтобы сохранить смысл по времени)
          base_minutes: 480          # 240*2
          trigger_minutes: 40         # 20*2
          max_signal_age_minutes: 60  # 30*2
          plot_lookback_bars: 110     # ≈ тот же горизонт по времени, что 220 свечей на 5m

          # Пороги BUY (15m) — сделаны ЧУТЬ строже (не ×3!)
          buy_oi_rise_pct: 1.3       # Было 0.7 на 5m → для 15m логичнее требовать сильнее рост OI
          oi_value_confirm_pct: 1.3  # Подтверждение по OI$ чуть строже
          buy_volume_mult: 1.9       # Средний объём должен сильнее выделяться на 15m
          buy_volume_spike_mult: 3.4 # Пик свечи тоже строже
          buy_price_rise_pct: 0.18   # Для 15m цена обычно ходит больше — порог выше
          buy_min_green_candles: 1   # Обычно достаточно 1 (можно сделать 2, если будет много мусора)
          buy_require_last_green: true

          # Пороги SELL (15m) — тоже чуть строже
          sell_oi_drop_one_candle_pct: 1.1
          sell_oi_drop_window_pct: 1.4
          sell_price_drop_last_pct: 0.45
          sell_reversal_from_max_pct: 1.1
          sell_volume_spike_mult: 2.1
          sell_volume_drop_ratio: 0.65

      # ==========================================================
      # PRICE: критерии «базы» (фон)
      # ==========================================================
      # Эти параметры определяют «условия фона» за base_minutes:
      # - флэт (небольшой диапазон)
      # - или снижение (чтобы BUY ловил набор OI «после слабости»)
      price_sideways_max_pct: 8.0   # Флэт: range% цены в базе <= порога
      price_downtrend_min_pct: 0.3  # Снижение: падение цены в базе >= порога (%)

      # ==========================================================
      # VOLUME: «тихая база»
      # ==========================================================
      # Чтобы импульс был заметен, база по объёму должна быть без экстремальных всплесков:
      # max(volume_base) <= median(volume_base) * base_volume_max_mult
      base_volume_max_mult: 4.0     # Чем меньше — тем строже «тишина» базы

      # ==========================================================
      # BUY: свечные подтверждения (общие дефолты, но override может менять)
      # ==========================================================
      buy_min_green_candles: 1      # Минимум зелёных свечей в trigger-окне (если override не задан)
      buy_require_last_green: true  # Требовать, чтобы последняя свеча в trigger-окне была зелёной

      # ==========================================================
      # OI — какие колонки использовать (из БД)
      # ==========================================================
      # В public.open_interest:
      #   open_interest       — контракты
      #   open_interest_value — USDT
      #
      # Рекомендуется:
      # - расчёт условий по open_interest (контракты) — цена не «раздувает» метрику
      # - график по open_interest_value (USDT) — нагляднее notional
      oi_calc_key: "open_interest"        # OI для расчёта условий (BUY/SELL)
      oi_plot_key: "open_interest_value"  # OI для графика

      # ==========================================================
      # Funding filter (BUY)
      # ==========================================================
      enable_funding: true                # Если true — BUY требует funding < buy_funding_max_pct
      buy_funding_max_pct: -0.0001        # BUY: funding должен быть ниже порога (0.0 = строго отрицательный)
      buy_require_funding_decreasing: false # Если true — funding должен снижаться (делает BUY строже)

      # ==========================================================
      # Funding filter (SELL)
      # ==========================================================
      sell_enable_funding: true           # Если true — SELL требует funding > sell_funding_min_pct
      sell_funding_min_pct: 0.0001        # SELL: funding должен быть выше порога (0.0 = строго положительный)

      # ==========================================================
      # РИСК: SL/TP
      # ==========================================================
      stop_loss_pct: 2.0                  # Stop-Loss (%) от входа: BUY ниже, SELL выше
      take_profit_pct: 5.0                # Take-Profit (%) от входа: BUY выше, SELL ниже

      # ==========================================================
      # СВЕЖЕСТЬ СИГНАЛОВ (анти-спам)
      # ==========================================================
      max_signal_age_minutes: 30          # Старше N минут — не пишем/не шлём (может override-иться на 15m)

      # ==========================================================
      # PLOTS: сохранение и ретеншн
      # ==========================================================
      plots_enabled: true                 # Сохранять графики (PNG)
      plots_dir: "artifacts/screener_plots" # Корневая папка для графиков
      plot_lookback_bars: 220             # Сколько свечей рисовать назад (может override-иться по ТФ)
      keep_plots_days: 2                  # Хранить графики не более N дней (по ТЗ: 2)

      # ==========================================================
      # TELEGRAM
      # ==========================================================
      telegram_send_messages: true        # Отправлять текстовые сообщения
      telegram_send_plots: true           # Отправлять графики
      telegram_silent: false              # Silent-режим (без уведомлений)

      telegram_extras_enabled: true      # Доп.рассылка «друзьям» (если у тебя это настроено)
      telegram_max_friends: 5            # Лимит друзей в доп.рассылке

      # ==========================================================
      # DEBUG
      # ==========================================================
      debug: true                         # Включить расширенные логи (dist/base/top списки)
      debug_top: 10                       # Сколько строк показывать в топ-листах кандидатов
