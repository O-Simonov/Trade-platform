# SLOW PROCESS: heavy collectors + universe/filters + OI + funding + ticker_24h + trades_all + retention
# ВАЖНО:
#   - WS свечи только 15m (самое стабильное)
#   - 1h/4h/1d делаем gap_repair'ом (REST)

exchange: binance
exchange_id: 1

rest_limits:
  # 2 rps на всё сразу (funding + gap_repair + хвосты) часто душит.
  # Это не "ускорение", это чтобы разные коллекторы не голодали.
  max_rps: 3.5
  max_rpm: 350
  force: true

startup_stagger:
  after_universe: 0.6
  after_symbol_filters: 0.8
  after_candles: 1.0
  after_open_interest: 1.0
  after_funding: 0.8
  after_ticker_24h: 0.8
  after_gap_repair: 8.0

universe:
  enabled: true
  seed_on_start: false
  refresh_sec: 21600
  min_size: 200
  max_drop_ratio: 0.30

symbol_filters:
  enabled: true
  refresh_sec: 7200
  seed_on_start: true

symbols_refresh:
  refresh_sec: 300

market_data:
  enabled: true

  # ✅ WS
  candle_intervals: ["15m","1h", "4h"]

  seed_on_start: true
  seed_days: 30
  seed_limit: 1500
  seed_max_pages_per_symbol: 3       # было 0
  seed_symbols_per_cycle: 4
  per_request_sleep_sec: 0.25
  seed_overlap_minutes: 60

  use_ws: true
  ws_max_streams_per_conn: 180
  ws_url_max_len: 3500

  ws_supervisor:
    enabled: true
    check_sec: 60
    debounce_checks: 2
    min_restart_sec: 180

  # ✅ реально только закрытые свечи (а не как было true)
  update_open_candle: false

  ws_ping_interval: 60
  ws_ping_timeout: 30

  # REST catchup при подключении (хвост)
  rest_catchup_on_connect: true
  catchup_max_symbols: 10
  rest_catchup_max_pages: 1
  rest_catchup_overlap_minutes: 60
  rest_catchup_limit: 1500
  catchup_seed_days: 2

open_interest:
  enabled: true
  intervals: ["5m","15m"]

  seed_on_start: false
  seed_days: 14
  seed_limit: 500
  seed_max_pages_per_symbol: 10
  seed_symbols_per_cycle: 2

  overlap_minutes: 60
  safety_lag_sec: 15

  poll_limit_max: 200
  poll_max_pages_per_symbol: 3
  batch_size: 10
  scan_sleep_sec: 0.10

  rate_limit:
    enabled: true
    ip_limit_per_5m: 1000
    window_sec: 300
    safety_factor: 0.70
    burst: 30
    backoff_min_sec: 1.0
    backoff_max_sec: 30.0

funding:
  enabled: true
  backfill_on_start: true
  backfill_days: 14               # было 30 (сильно снижает стартовую нагрузку)

  use_ws: true

  rest_safety_poll: true
  poll_sec: 3600                   # было 1800

  symbols_per_cycle: 10            # было 20
  req_sleep_sec: 0.25              # было 0.20

  limit: 1000
  max_pages: 25                    # было 50
  page_sleep_sec: 0.05             # было 0.0

  overlap_hours: 72

liquidations:
  enabled: false

ticker_24h:
  enabled: true
  source: ws_24h
  flush_sec: 10
  ws_stream: "!ticker@arr"
  ws_ping_interval: 60
  ws_ping_timeout: 30
  rest_safety_poll: false

market_state_5m:
  enabled: false
  poll_sec: 15                     # было 10 (чуть разгружаем)
  symbols_per_cycle: 30            # было 40
  lookback_minutes: 180
  refresh_symbols_sec: 300

market_trades_all:
  enabled: false
  use_ws: true

  ws_max_streams_per_conn: 160
  ws_url_max_len: 3500
  ws_ping_interval: 60
  ws_ping_timeout: 30

  flush_sec: 1.0                   # было 0.75
  flush_max_rows: 5000

  overlap_minutes: 60
  agg_upsert_every_sec: 15         # было 10
  recalc_cvd_every_sec: 180        # было 120
  cvd_hours_back: 24

  tail_sync_enabled: true
  lag_tail_sec: 600
  tail_sync_every_sec: 6           # было 5
  tail_sync_symbols_per_cycle: 2
  tail_sync_limit: 1000
  tail_sync_max_pages_per_symbol: 3
  tail_sync_max_requests_per_cycle: 6
  tail_sync_min_symbol_interval_sec: 60  # было 45
  tail_sync_safety_lag_sec: 3

  warmup_enabled: true
  warmup_sec: 180
  warmup_lag_tail_sec: 60
  warmup_tail_sync_every_sec: 4          # было 3
  warmup_tail_sync_symbols_per_cycle: 3
  warmup_tail_sync_max_requests_per_cycle: 8
  warmup_tail_sync_max_pages_per_symbol: 4
  warmup_tail_sync_min_symbol_interval_sec: 25  # было 20

candles_gap_repair:
  enabled: true
  every_sec: 1800
  max_symbols_per_cycle: 40
  max_gaps_per_cycle: 10

  # ✅ добиваем старшие ТФ только REST'ом (WS там больше не включен)
  intervals: ["1h", "4h", "1d"]
  only_active_symbols: true
  gaps_per_symbol: 2

  max_gap_days: 30
  min_gap_points: 1

  limit: 1500
  sleep_sec: 0.25

  priority: 1
  priority_symbols: []

retention:
  enabled: true
  run_sec: 3600
  log_each_cycle: true
  log_zero_deletes: true

  candles_days: 180
  candle_intervals: ["1m", "5m", "15m", "1h", "4h", "1d"]

  # раз OI теперь только 5m — оставляем только его
  oi_keep_days:
    "5m": 30

  funding_days: 90
  ticker_24h_days: 30

  market_state_5m_days: 30

  market_trades_days: 30
  candles_trades_agg_days: 60
