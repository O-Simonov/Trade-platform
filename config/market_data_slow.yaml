# SLOW PROCESS: heavy collectors + universe/filters + OI + funding + ticker_24h + trades_all + retention
# ВАЖНО:
#   - WS свечи только 15m (самое стабильное)
#   - 1h/4h/1d делаем gap_repair'ом (REST)

exchange: binance
exchange_id: 1

rest_limits:
  max_rps: 2.0
  max_rpm: 250
  force: true

startup_stagger:
  after_universe: 0.6
  after_symbol_filters: 0.8
  after_candles: 1.0
  after_open_interest: 1.0
  after_funding: 0.8
  after_ticker_24h: 0.8
  after_gap_repair: 8.0

universe:
  enabled: true
  seed_on_start: false
  refresh_sec: 21600
  min_size: 200
  max_drop_ratio: 0.30

symbol_filters:
  enabled: true
  refresh_sec: 7200
  seed_on_start: true

symbols_refresh:
  refresh_sec: 60

market_data:
  enabled: true

  # ✅ WS
  candle_intervals: ["15m","1h", "4h", "1d"]

  seed_on_start: true
  seed_days: 30
  seed_limit: 1500
  seed_max_pages_per_symbol: 0
  seed_symbols_per_cycle: 5
  per_request_sleep_sec: 0.25
  seed_overlap_minutes: 60

  use_ws: true
  # ✅ больше символов в одном WS (меньше коннектов)
  ws_max_streams_per_conn: 180
  ws_url_max_len: 3500

  ws_supervisor:
    enabled: true
    check_sec: 60
    debounce_checks: 2
    min_restart_sec: 180

  # ✅ только закрытые свечи
  update_open_candle: true

  # ✅ ping/pong стабильнее
  ws_ping_interval: 60
  ws_ping_timeout: 30

  # REST catchup при подключении (хвост)
  rest_catchup_on_connect: true
  catchup_max_symbols: 10          # было 80
  rest_catchup_max_pages: 1        # было 2
  rest_catchup_overlap_minutes: 60 # было 180

  rest_catchup_limit: 1500
  catchup_seed_days: 2

open_interest:
  enabled: true
  intervals: ["5m", "15m", "1h", "4h", "1d"]

  seed_on_start: false
  seed_days: 30
  seed_limit: 500
  seed_max_pages_per_symbol: 8
  seed_symbols_per_cycle: 10

  poll_sec: 60
  batch_size: 20

  per_request_sleep_sec: 0.12
  overlap_minutes: 60
  safety_lag_sec: 15

  refresh_symbols_sec: 3600
  log_each_cycle: true

  stall_hits_to_blacklist: 3
  blacklist_hours: 6
  blacklist_log_every_sec: 120

  schedule:
    "5m": 25
    "15m": 240
    "1h": 1200
    "4h": 3600
    "1d": 21600
  schedule_jitter_sec: 1.0

  dynamic_budget:
    enabled: true
    safety_factor: 0.90
    endpoint_weight: 2.0
    min_symbols_per_tick: 5
    max_symbols_per_tick_cap: 50

  adaptive:
    enabled: true
    penalty_step: 5
    recovery_step: 1
    extra_sleep_penalty_sec: 0.10
    extra_sleep_recovery_sec: 0.01
    extra_sleep_max_sec: 0.50
    post_tick_sleep_max_sec: 20.0

funding:
  enabled: true
  backfill_on_start: true
  backfill_days: 30

  use_ws: true

  rest_safety_poll: true
  poll_sec: 1800

  symbols_per_cycle: 20
  req_sleep_sec: 0.20

  limit: 1000
  max_pages: 50
  page_sleep_sec: 0.0

  overlap_hours: 72

ticker_24h:
  enabled: true
  source: ws_24h
  flush_sec: 10
  ws_stream: "!ticker@arr"
  ws_ping_interval: 60
  ws_ping_timeout: 30
  rest_safety_poll: false


market_state_5m:
  enabled: true
  poll_sec: 10
  symbols_per_cycle: 40
  lookback_minutes: 180
  refresh_symbols_sec: 300

market_trades_all:
  enabled: true
  use_ws: true

  ws_max_streams_per_conn: 160
  ws_url_max_len: 3500
  ws_ping_interval: 60
  ws_ping_timeout: 30

  flush_sec: 0.75
  flush_max_rows: 5000

  overlap_minutes: 60
  agg_upsert_every_sec: 10
  recalc_cvd_every_sec: 120
  cvd_hours_back: 24

  # normal tail sync (после warmup)
  tail_sync_enabled: true
  lag_tail_sec: 600
  tail_sync_every_sec: 5
  tail_sync_symbols_per_cycle: 2
  tail_sync_limit: 1000
  tail_sync_max_pages_per_symbol: 3
  tail_sync_max_requests_per_cycle: 6
  tail_sync_min_symbol_interval_sec: 45
  tail_sync_safety_lag_sec: 3

  # ✅ WARMUP: ускоренный догон первые 3 минуты
  warmup_enabled: true
  warmup_sec: 180
  warmup_lag_tail_sec: 60
  warmup_tail_sync_every_sec: 3
  warmup_tail_sync_symbols_per_cycle: 3
  warmup_tail_sync_max_requests_per_cycle: 8
  warmup_tail_sync_max_pages_per_symbol: 4
  warmup_tail_sync_min_symbol_interval_sec: 20

market_trades:
  enabled: false

candles_gap_repair:
  enabled: true
  every_sec: 1800   # было 600
  max_symbols_per_cycle: 40
  max_gaps_per_cycle: 10

  # ✅ Тут добиваем старшие ТФ вместо WS
  intervals: ["1h", "4h", "1d"]
  only_active_symbols: true
  gaps_per_symbol: 2

  max_gap_days: 30
  min_gap_points: 1

  limit: 1500
  sleep_sec: 0.25

  priority: 1
  priority_symbols: []

retention:
  enabled: true
  run_sec: 3600
  log_each_cycle: true
  log_zero_deletes: true

  candles_days: 180
  candle_intervals: ["1m", "5m", "15m", "1h", "4h", "1d"]

  oi_keep_days:
    "5m": 14
    "15m": 60
    "1h": 90
    "4h": 180
    "1d": 365

  funding_days: 90
  ticker_24h_days: 30

  market_state_5m_days: 30

  market_trades_days: 30
  candles_trades_agg_days: 60
