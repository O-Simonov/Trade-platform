restart_interval_minutes: 5  # Как часто перезапускать скринеры (мин). Полный цикл: загрузка → расчёт → вставка сигналов/графики → сон.

screeners:
  - name: scr_liquidation_binance        # Имя скринера (должно совпадать с реестром в run_screeners.py)
    enabled: true                        # Включить/выключить этот скринер
    version: "0.1"                       # Версия скринера (пишется в БД через ensure_screener)

    params:
      # ---------------------------
      # Базовые фильтры
      # ---------------------------
      intervals: ["15m","1h","4h"]       # Таймфреймы, которые скринер анализирует (для каждого будет отдельный прогон)
      min_price: 0.0000001               # Отсечь слишком дешёвые монеты (фильтр по текущей цене)
      max_price: 1000                    # Отсечь слишком дорогие монеты (фильтр по текущей цене)

      volume_liquid_limit: [7000,14000,21000]  # Мин. объём ликвидаций в anchor-свече (USDT). Маппинг по intervals:
                                                # 15m→7000, 1h→14000, 4h→21000.
                                                # Если не проходит — сигнал по символу игнорируется.

      liq_dominance_pct: 10.0            # Требуемое доминирование ликвидаций в %:
                                         # SELL: short_liq >= long_liq * (1 + pct/100)
                                         # BUY : long_liq >= short_liq * (1 + pct/100)

      # ==========================================================
      # ✅ LIVE CANDLES (без задержек)
      # ==========================================================
      live_candles_enabled: true         # Включить режим "живых" старших ТФ: строим 1h/4h из базового интервала (обычно 15m)
      live_base_interval: "15m"          # Базовый ТФ, из которого агрегируем старшие (должен стабильно собираться коллектором)
      live_prefer_agg: true             # Предпочитать агрегацию (15m→1h/4h) вместо чтения "родных" 1h/4h свечей из БД
      live_extra_base_bars: 64           # Запас базовых баров при агрегации (помогает при краях окна/дырках/смещениях)

      # ==========================================================
      # ✅ RISK / POSITION SIZE
      # ==========================================================
      risk_trade_pct: 1.0                # Риск на сделку в % от equity (например 1.0 = 1% от капитала)
      risk_equity_usdt: 1000             # Equity в USDT для расчёта риска; null => брать equity из БД (account_state/account_balance_snapshots)
      risk_account_id: 1                 # account_id, из которого читать equity в БД (если risk_equity_usdt=null)

      # ==========================================================
      # ✅ STOP LOSS / TAKE PROFIT (ТОЛЬКО %)
      # ==========================================================
      stop_loss_pct: 2.0                 # SL в % от entry (например 2.0 = 2%)
      take_profit_mode: "pct"            # Режим TP (в проекте оставлен только percent-режим)
      take_profit_pct: 6.0               # TP в % от entry (например 6.0 = 6%)

      entry_price_mode: confirm_close    # Откуда брать цену входа (entry):
                                         # current       -> текущая цена (ticker_24h.last_price, fallback close)
                                         # anchor_close  -> close anchor-свечи (с крупной ликвидацией)
                                         # confirm_close -> close свечи подтверждения (обычно самый "консервативный" entry)

      # ---------------------------
      # Уровни / Логика
      # ---------------------------
      period_levels: 240                 # Сколько свечей брать для поиска уровней S/R (чем больше — тем устойчивее уровни)
      pivot_left: 4                      # Сколько свечей слева нужно для pivot (локальный экстремум)
      pivot_right: 4                     # Сколько свечей справа нужно для pivot
      level_cluster_tol_pct: 0.003       # Толеранс кластеризации уровней (0.003=0.3%): близкие уровни объединяются
      max_level_candidates: 14           # Максимум уровней-кандидатов после кластеризации
      level_tol_pct: 0.0075              # Допуск касания уровня (±0.5%) для проверки touch/cross

      # ==========================================================
      # ✅ TOUCH / PRE-TOUCH
      # ==========================================================
      touch_lookback_candles: 5          # Сколько последних свечей (включая anchor) проверять на касание/пробой уровня
      touch_mode: "touch_or_cross"       # Режим проверки уровня:
                                         # touch -> только касание (high/low в допуске)
                                         # cross -> только пересечение (пробой через уровень)
                                         # touch_or_cross -> любой из вариантов

      # ==========================================================
      # ✅ CONFIRMATION (ВАЖНО: убираем лаг на больших TF)
      # ==========================================================
      confirm_lookforward: 2             # Fallback: сколько свечей после anchor смотреть подтверждение направления (закрытые свечи)
                                         # Для больших ТФ высокий lookforward даёт "задержку" сигналов.

      confirm_lookforward_map:           # Карта per-TF: задаёт confirm_lookforward по каждому таймфрейму
        "15m": 4                         # На 15m допускаем больше подтверждающих свечей
        "1h": 3                          # На 1h меньше
        "4h": 2                          # На 4h минимально
      # ---------------------------
      # ✅ Фильтр "аномального объёма свечи"
      # ---------------------------
      windows: 20                        # Окно свечей ДО anchor для расчёта средней нормы объёма (avg_volume)
      kof_Volume: 1.25                   # Порог аномальности объёма: volume_anchor / avg_volume >= kof_Volume
                                         # 0 => отключить фильтр; 3.0 довольно жёстко.

      # ==========================================================
      # ✅ СВЕЖЕСТЬ СИГНАЛОВ (ОТБРАСЫВАЕМ СТАРЫЕ)
      # ==========================================================
      fresh_signal_minutes: 20              # Fallback: порог свежести (мин). 0/<=0 => отключить фильтр свежести.
      fresh_signal_minutes_map:             # Per-TF пороги свежести (мин). Если ключа нет — используется fresh_signal_minutes.
        "15m": 20
        "1h": 20
        "4h": 20
      # Примечание: в run_screeners свежесть считается по close-time: signal_ts + длительность интервала.
      # Это важно в live-агрегации 15m→1h/4h, когда signal_ts часто равен open-time старшей свечи.

      # ---------------------------
      # Опциональные подтверждения
      # ---------------------------
      enable_funding: true               # Учитывать funding-фильтр/подтягивать funding в контекст (если таблицы funding есть и обновляются)
      kof_fund: 0.001                    # Порог funding (в %). Обычно внутри переводится в долю: 0.005% => 0.00005
      enable_oi: false                   # Включить проверку open_interest (если есть данные и логика включена в скринере)
      enable_cvd: false                  # Включить проверку CVD (если market_trades/CVD расчёт включён)

      # ---------------------------
      # ✅ Графики
      # ---------------------------
      enable_plots: true                      # Генерировать PNG графики для сигналов
      plots_dir: "artifacts/screener_plots"   # Папка, куда сохранять графики
      plots_keep_days: 2                      # хранить графики только N дней (по умолчанию 2)
      plots_cleanup_every_minutes: 60         # как часто запускать очистку (минуты)
      plot_lookback: 120                      # Сколько свечей показать "назад" от центра окна графика
      plot_lookforward: 40                    # Сколько свечей показать "вперёд" от центра окна графика
      plot_max_signals: 50                    # Максимум графиков за прогон (ограничение CPU/диска)

      # ---------------------------
      # Дебаг
      # ---------------------------
      debug: true                        # Включить расширенные логи "почему не прошёл фильтр"
      debug_top: 20                      # Сколько символов выводить в DEBUG TOP (обычно по сумме liq_long+liq_short)

      # ✅ TELEGRAM
      telegram_enabled: true             # Включить отправку в Telegram
      telegram_timezone: "Europe/Moscow" # Таймзона для отображения времени в сообщениях/подписях

      telegram_extras_enabled: true      # Отправлять также "друзьям/доп.чатам" (если настроено в .env)
      telegram_max_friends: 2            # Максимум дополнительных получателей (friends), чтобы не спамить всем сразу

      telegram_send_text: false          # Отправлять текстовые сообщения (batch/single). false => текст не шлём
      telegram_send_plots: true          # Отправлять графики (photo/document) с подписью
      telegram_plot_mode: "photo"        # Режим отправки графиков: photo (сжатие) или document (без сжатия)
      telegram_max_plot_signals: 50      # Максимум графиков, которые отправим в Telegram за прогон
      telegram_send_plot_followup_text: false  # Второе короткое сообщение после картинки (true/false)
