# ------------------------------------------------------------
# Trading Instances config
# Стратегия: trade_liquidation
# Источник сигналов: scr_liquidation_binance (таблица signals)
# ------------------------------------------------------------

instances:
  - instance_id: 10
    exchange: binance_usdm
    role: BASE
    account: BASE

    # ВАЖНО:
    # Сейчас движок инстанса ожидает список symbols для подписок/идентификаторов.
    # Для trade_liquidation мы позже сделаем расширение "из БД", а пока можно:
    #  - либо перечислить нужные символы вручную,
    #  - либо поставить самые ликвидные, чтобы начать тест.
    symbols: ["BTCUSDT", "ETHUSDT", "BNBUSDT", "SOLUSDT", "XRPUSDT"]

    # Таймфрейм здесь не критичен для исполнения, но пусть будет базовый
    timeframe: "1m"

    strategy: trade_liquidation

    params:
      # ==========================================================
      # ИСТОЧНИК СИГНАЛОВ (signals)
      # ==========================================================
      signal_source: "scr_liquidation_binance"     # signals.source (от какого скринера берём)
      signal_status_new: "NEW"                     # какие сигналы считаем "новыми"
      signal_status_taken: "TAKEN"                 # во что переводим после взятия в работу
      signal_status_done: "DONE"                   # опционально: когда позиция закрыта
      signal_status_error: "ERROR"                 # если не смогли исполнить

      max_signal_age_minutes: 15                   # не брать устаревшие сигналы
      poll_signals_every_sec: 3                    # как часто опрашивать БД на новые сигналы

      max_active_symbols: 3                        # максимум одновременно торгуемых символов
      one_position_per_symbol: true                # не открывать 2 позиции по одному символу

      # ==========================================================
      # БАЛАНС / РИСК / РАЗМЕР ПОЗИЦИИ
      # ==========================================================
      balance_exchange_id: 1                       # Binance=1
      balance_asset: "USDT"                        # какую валюту считать депозитом
      balance_field: "wallet_balance"              # wallet_balance | available_balance (если появится)

      # risk_per_trade_pct — это "сколько USDT я готов потерять на 1 сделку"
      # Пример: wallet_balance=1000, risk_per_trade_pct=1% → risk_usdt=10 USDT.
      risk_per_trade_pct: 1.0

      # Если пересчёт SL/TP включён, то stop_loss_pct используется для расчёта позиции:
      # position_notional_usdt = risk_usdt / (stop_loss_pct/100)
      stop_loss_pct: 2.0

      # take_profit_pct — цель от средней цены входа (avg fill)
      take_profit_pct: 6.0

      # Плечо (если будешь задавать в стратегии/OMS)
      leverage: 5

      # Ограничения безопасности
      min_notional_usdt: 10                        # не открывать позиции меньше минималки
      max_notional_usdt: 0                         # 0 = без лимита, иначе ограничить сверху

      # ==========================================================
      # SL/TP: ПЕРЕСЧЁТ или ВЗЯТЬ ИЗ SIGNALS
      # ==========================================================
      sltp_recalc_enabled: true
      # true  → стратегия выставляет/обновляет SL/TP по своим процентам (stop_loss_pct/take_profit_pct)
      # false → стратегия берёт entry/SL/TP из signals (entry_price/stop_loss/take_profit)

      # Если recalc включён — пересчитывать SL/TP после:
      # - открытия (получили avg fill price)
      # - усреднений (изменился average entry)
      sltp_recalc_on_position_change: true

      # Если recalc выключён — брать поля из signals:
      # (в таблице signals есть: entry_price, stop_loss, take_profit)
      sltp_use_signal_fields_when_disabled: true

      # ==========================================================
      # ОРДЕРА: ВХОД/ВЫХОД (выбор типа закрытия)
      # ==========================================================
      entry_order_type: "market"                   # market (по ТЗ)

      # Как закрываем позицию:
      # - "market"              → просто закрыть рынком при достижении условий (нужен мониторинг цены)
      # - "conditional_market"  → поставить STOP_MARKET и TAKE_PROFIT_MARKET (предпочтительно)
      # - "conditional_limit"   → поставить STOP_LIMIT / TAKE_PROFIT_LIMIT
      # - "limit"               → поставить лимитный TP (SL тогда отдельно)
      exit_mode: "conditional_market"

      # Общие флаги выходных ордеров
      exit_reduce_only: true
      exit_close_position: true                    # если биржа поддерживает closePosition

      # ==========================================================
      # TRAILING STOP
      # ==========================================================
      trailing_enabled: false

      # Активация трейлинга: когда цена прошла в прибыль минимум на N%
      trailing_activation_pct: 2.0

      # Следование: насколько "отпускаем" от max/min
      # Для LONG: стоп = max_price * (1 - trailing_callback_pct/100)
      # Для SHORT: стоп = min_price * (1 + trailing_callback_pct/100)
      trailing_callback_pct: 0.6

      # Как реализуем trailing:
      # - "exchange" → если будем ставить trailing-ордер на бирже
      # - "local"    → если будем считать вручную и закрывать по условию
      trailing_engine: "local"

      # ==========================================================
      # УСРЕДНЕНИЕ (DCA) НА ЗНАЧИМЫХ УРОВНЯХ HTF (1h/4h)
      # ==========================================================
      averaging_enabled: false

      averaging_max_adds: 2                        # сколько раз максимум усредняем
      averaging_add_size_mode: "fixed_usdt"        # fixed_usdt | risk_pct
      averaging_add_size_value: 50                 # если fixed_usdt → 50 USDT на добавку
      # если risk_pct → % от wallet_balance на добавку (аналог risk_per_trade_pct)

      # Откуда брать уровни:
      averaging_levels_tf: "1h"                    # "1h" или "4h"
      averaging_levels_lookback_hours: 168         # за какой период искать уровни (7 дней)
      averaging_levels_method: "pivots"            # pivots | fractals | swing (сделаем позже)

      # Насколько близко к уровню считаем "касание" (в % от цены)
      averaging_level_tolerance_pct: 0.15

      # ==========================================================
      # HEDGE MODE (на том же счёте)
      # ==========================================================
      hedge_enabled: false
      hedge_mode: "same_account"                   # пока заглушка под твой будущий ТЗ
      hedge_max_ratio: 1.0                         # макс. объём хеджа относительно базы (1.0 = 100%)
      hedge_rules: {}                              # сюда добавим условия, когда ты пришлёшь

      # ==========================================================
      # ПРОЧЕЕ / ЗАЩИТА ОТ СПАМА / КУЛДАУНЫ
      # ==========================================================
      per_symbol_cooldown_sec: 60                  # не входить повторно по символу слишком часто
      max_orders_per_minute: 30                    # защита от "разгона" ордеров

      debug: true
