# SLOW PROCESS: heavy collectors + higher TF candles + OI + funding + ticker_24h + trades_all + universe/filters + retention
# Purpose:
#   - Universe + Filters
#   - candles: 15m/1h/4h/1d (NO 1m/5m)
#   - open interest hist: 5m/15m/1h/4h/1d with stall blacklist
#   - market_trades_all for delta/CVD
#   - gap repair WITHOUT 5m (avoid conflicts with FAST WS)
#   - retention cleanup

exchange: binance
exchange_id: 1

# ✅ SLOW is heavy: keep REST limits low
rest_limits:
  max_rps: 2.0
  max_rpm: 250
  force: true

startup_stagger:
  after_universe: 0.6
  after_symbol_filters: 0.8
  after_candles: 1.0
  after_open_interest: 1.0
  after_funding: 0.8
  after_ticker_24h: 0.8
  after_gap_repair: 10.0

# ✅ Universe only in SLOW
universe:
  enabled: true
  seed_on_start: false
  refresh_sec: 21600
  min_size: 200
  max_drop_ratio: 0.30

# ✅ Symbol filters only in SLOW
symbol_filters:
  enabled: true
  refresh_sec: 7200
  seed_on_start: true

symbols_refresh:
  refresh_sec: 60

# ✅ Higher TF candles only (NO 1m/5m)
#candles:
market_data:
  enabled: true
  candle_intervals: [ "15m","1h","4h","1d" ]
  seed_on_start: true
  seed_days: 30
  seed_limit: 1500
  seed_max_pages_per_symbol: 0      # ✅ авто под интервал
  seed_symbols_per_cycle: 4
  per_request_sleep_sec: 0.20
  seed_overlap_minutes: 60

  use_ws: true
  ws_max_streams_per_conn: 120
  update_open_candle: true

  # ✅ фикс разрывов при падениях WS
  rest_catchup_on_connect: true
  rest_catchup_overlap_minutes: 120
  rest_catchup_limit: 1500
  rest_catchup_max_pages: 2

# ✅ Open Interest (heavy)
open_interest:
  enabled: true
  intervals: ["5m", "15m", "1h", "4h", "1d"]

  seed_on_start: false
  seed_days: 30
  seed_limit: 500
  seed_max_pages_per_symbol: 8
  seed_symbols_per_cycle: 10

  poll_sec: 60
  batch_size: 20

  per_request_sleep_sec: 0.12
  overlap_minutes: 60
  safety_lag_sec: 15

  refresh_symbols_sec: 3600
  log_each_cycle: true

  # ✅ auto-blacklist stalled
  stall_hits_to_blacklist: 3
  blacklist_hours: 6
  blacklist_log_every_sec: 120

  # ✅ per-interval schedules (added 1h/4h/1d)
  schedule:
    "5m": 20            # каждые 20 секунд
    "15m": 240          # каждые 4 минуты
    "1h": 1200          # каждые 20 минут
    "4h": 3600          # каждый час
    "1d": 14400         # каждый день
  schedule_jitter_sec: 1.0

  dynamic_budget:
    enabled: true
    safety_factor: 0.90  # безопасность на 90%
    endpoint_weight: 2.0 # вес конечной точки (можно уменьшить, если возникают ошибки)
    min_symbols_per_tick: 5
    max_symbols_per_tick_cap: 50 # ограничение количества символов на тик

  adaptive:
    enabled: true
    penalty_step: 5
    recovery_step: 1
    extra_sleep_penalty_sec: 0.10  # увеличена задержка после ошибок 429
    extra_sleep_recovery_sec: 0.01
    extra_sleep_max_sec: 0.50
    post_tick_sleep_max_sec: 20.0  # увеличена пауза после каждого цикла

# ✅ Funding

funding:
  enabled: true
  backfill_on_start: true
  backfill_days: 30

  # if you have WS support - keep ON, REST is safety
  use_ws: true

  # REST safety
  rest_safety_poll: true
  poll_sec: 1800

  symbols_per_cycle: 20
  req_sleep_sec: 0.20

  limit: 1000
  max_pages: 50
  page_sleep_sec: 0.0

  overlap_hours: 72

# ✅ Ticker 24h
ticker_24h:
  enabled: true
  poll_sec: 600
  source: rest_24h

market_state_5m:
  enabled: true
  poll_sec: 10
  symbols_per_cycle: 40
  lookback_minutes: 180
  refresh_symbols_sec: 300

# ✅ delta/CVD for all symbols (soft limits)
market_trades_all:
  enabled: true

  poll_sleep: 0.10
  req_sleep_sec: 0.08
  symbols_per_cycle: 15

  overlap_minutes: 60
  lag_tail_sec: 600

  refresh_symbols_sec: 600
  max_symbols: 0

  recalc_cvd_every_sec: 120
  cvd_hours_back: 24


# ✅ single-symbol trades collector is not needed
market_trades:
  enabled: false

# ✅ gap repair - NO 5m (avoid FAST conflict)
candles_gap_repair:
  enabled: true
  intervals: ["4h", "1h", "15m", "5m"]     # можно расширять
  every_sec: 600                          # раз в 10 минут
  only_active_symbols: true

  max_symbols_per_cycle: 60
  max_gaps_per_cycle: 20
  gaps_per_symbol: 2

  max_gap_days: 30                        # ✅ критично (не 0)
  min_gap_points: 1

  limit: 1500
  sleep_sec: 0.25

  priority: 1                             # 0=агрессивно, 1=норм, 2=медленно
  priority_symbols: ["BTCUSDT","ETHUSDT"]

# ✅ retention only in SLOW
retention:
  enabled: true
  run_sec: 3600
  log_each_cycle: true
  log_zero_deletes: true

  candles_days: 90
  candle_intervals: ["1m","5m","15m","1h","4h","1d"]

  oi_keep_days:
    "5m": 14
    "15m": 60
    "1h": 90
    "4h": 180
    "1d": 365

  funding_days: 90
  ticker_24h_days: 60

  market_state_5m_days: 30

  # ✅ NEW
  market_trades_days: 14
  candles_trades_agg_days: 60

