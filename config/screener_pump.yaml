# config/screener_pump.yaml
# ------------------------------------------------------------
# PUMP screener config (scr_pump_binance)
#
# Runner:
#   - BUY runner: buy_interval (run_screener_pump.py запускает scr_pump_binance с interval=buy_interval и mode=buy)
#   - SELL runner: sell_interval (run_screener_pump.py запускает scr_pump_binance с interval=sell_interval и mode=sell)
#
# Подтверждения:
#   - OI / CVD всегда берём с oi_interval / cvd_interval (обычно 5m)
#
# Антишум:
#   - steps (2-step): require_2step_oi_cvd + confirm_trend_bars + oi_eps/cvd_eps
#   - slope (регрессия): trend_method=slope|both + slope_bars + BUY/SELL пороги (раздельные)
#
# ВАЖНО:
#   - steps и slope управляются ОДНИМ ключом trend_method: off|steps|slope|both
#   - trend_mode: none|oi|cvd|both (что именно проверять)
# ------------------------------------------------------------

restart_interval_minutes: 2

screeners:
  - name: scr_pump_binance
    enabled: true
    version: "0.1"

    params:
      # ==========================================================
      # Базовые настройки
      # ==========================================================
      buy_interval: "5m"
      sell_interval: "15m"

      exchange_id: 1
      min_price: 0.0000001
      max_price: 1000

      max_symbols: 0              # 0 = все активные
      scan_lookback_bars: 480     # >= max(lookback) + запас под окно/confirm

      signal_mode: "both"         # both|buy|sell (обычно runner сам ставит buy/sell)
      max_signal_age_minutes: 30  # используется в run_screener_pump.py для отсева "протухших" сигналов

      # ==========================================================
      # BUY (рост относительно средней)
      # ==========================================================
      buy_window_minutes: 5
      buy_price_change_pct: 3.0
      buy_base_lookback_bars: 240

      # ==========================================================
      # SELL (памп + красная свеча)
      # ==========================================================
      sell_window_minutes: 15
      sell_pump_pct: 10.0               # ⚠️ у тебя в логах top ~3.9% => при 10% будет редко/никогда
      sell_base_lookback_bars: 240
      sell_confirm_lookforward: 6       # сколько свечей после пампа ищем "красную" (внутри этого окна)

      # ==========================================================
      # OI / CVD источники + дельты (prev->end)
      # ==========================================================
      enable_oi: true
      enable_cvd: true

      oi_interval: "5m"
      cvd_interval: "5m"

      buy_min_oi_delta: 0.0
      buy_min_cvd_delta: 0.0
      sell_max_oi_delta: 0.0
      sell_max_cvd_delta: 0.0

      # ==========================================================
      # АНТИШУМ 1: steps (2-step)
      # ==========================================================
      # legacy-ключ: если true -> код сам включает trend_method=steps, если trend_method не задан
      require_2step_oi_cvd: true

      confirm_trend_bars: 2   # 2 шага => 3 точки (t-2,t-1,t)
      trend_strict: true      # strict: шаги должны быть > eps (BUY) / < -eps (SELL)

      # "Мягко" (включено)
      oi_eps: 2000
      cvd_eps: 2000

      # "Нормально" (закомментировано)
      # oi_eps: 5000
      # cvd_eps: 5000

      # "Жёстко" (закомментировано)
      # oi_eps: 12000
      # cvd_eps: 9000

      # ==========================================================
      # АНТИШУМ 2: slope (регрессия) — РАЗДЕЛЬНЫЕ пороги BUY/SELL
      # ==========================================================
      # trend_method:
      #   steps -> только 2-step (мягче, рекомендуется стартовать)
      #   both  -> steps + slope (жёстче, меньше сигналов)
      trend_method: "steps"
      # trend_method: "both"

      # Что именно проверять в тренде:
      #   both -> проверяем и OI и CVD (самый строгий)
      #   oi   -> только OI
      #   cvd  -> только CVD
      trend_mode: "both"

      # Сколько точек для slope (регрессия по последним N точкам)
      # (можешь использовать только trend_slope_points, slope_bars тогда не нужен)
      trend_slope_points: 9
      slope_bars: 9
      slope_strict: true

      # --- BUY пороги (мягко) ---
      # OI slope: bps/бар по ln(OI) * 10000
      # CVD slope_norm: slope / median(abs_delta)
      buy_oi_slope_min_bps: 8.0
      buy_cvd_slope_norm_min: 0.8

      # Нормально ~ p95 (закомментировано)
      # buy_oi_slope_min_bps: 13.3
      # buy_cvd_slope_norm_min: 1.26

      # Жёстко (закомментировано)
      # buy_oi_slope_min_bps: 20.0
      # buy_cvd_slope_norm_min: 2.0

      # --- SELL пороги (мягко) ---
      # ВАЖНО: это "максимум" (отрицательный), т.е. условие: value <= threshold
      sell_oi_slope_max_bps: -8.0
      sell_cvd_slope_norm_max: -1.34

      # Нормально (закомментировано)
      # sell_oi_slope_max_bps: -13.95
      # sell_cvd_slope_norm_max: -1.85

      # Жёстко (закомментировано)
      # sell_oi_slope_max_bps: -35.38
      # sell_cvd_slope_norm_max: -2.96

      # ----------------------------------------------------------
      # BACKWARD COMPAT (старые симметричные ключи)
      # Оставлены закомментированными, чтобы не мешали:
      # ----------------------------------------------------------
      # oi_slope_min_bps_per_bar: 8.0
      # cvd_slope_min_k: 0.8

      # ==========================================================
      # Funding (в ПРОЦЕНТАХ: funding_pct = funding_rate * 100)
      # ==========================================================
      enable_funding: true
      buy_funding_max_pct: -0.01
      sell_funding_min_pct: 0.01

      # ==========================================================
      # SL/TP
      # ==========================================================
      stop_loss_pct: 2.0
      take_profit_pct: 5.0

      # ==========================================================
      # Графики
      # ==========================================================
      enable_plots: true
      plots_dir: "artifacts/screener_plots"
      plot_lookback: 180
      plot_lookforward: 30

      # ==========================================================
      # TELEGRAM
      # ==========================================================
      telegram_enabled: true
      telegram_timezone: "Europe/Moscow"
      telegram_extras_enabled: true
      telegram_max_friends: 2

      telegram_send_text: true
      telegram_mode: "batch"
      telegram_max_signals: 50

      telegram_send_plots: true
      telegram_plot_mode: "photo"
      telegram_max_plot_signals: 30
      telegram_send_plot_followup_text: false

      # ==========================================================
      # Debug
      # ==========================================================
      debug: true
      debug_top: 20
