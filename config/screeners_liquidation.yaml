restart_interval_minutes: 5  # Как часто перезапускать скринер (мин). Полный цикл: загрузка → расчёт → вставка сигналов/графики → сон.

screeners:
  - name: scr_liquidation_binance        # Имя скринера (должно совпадать с реестром в run_screeners_liquidation.py)
    enabled: true                        # Включить/выключить этот скринер
    version: "0.1"                       # Версия скринера (пишется в БД через ensure_screener)

    params:
      # ---------------------------
      # Базовые фильтры
      # ---------------------------
      intervals: ["15m", "1h", "4h"]      # Таймфреймы, которые скринер анализирует (для каждого будет отдельный прогон)
      min_price: 0.0000001               # Отсечь слишком дешёвые монеты (фильтр по текущей цене)
      max_price: 1000                    # Отсечь слишком дорогие монеты (фильтр по текущей цене)

      # Мин. объём ликвидаций в anchor-свече (USDT). Маппинг по intervals:
      #   15m→7000, 1h→14000, 4h→21000
      # Если не проходит — сигнал по символу игнорируется.
      volume_liquid_limit: [7000, 14000, 21000]

      # Требуемое доминирование ликвидаций в %:
      #   SELL: short_liq >= long_liq * (1 + pct/100)
      #   BUY : long_liq  >= short_liq * (1 + pct/100)
      liq_dominance_pct: 10.0

      # ==========================================================
      # ✅ LIVE CANDLES (без задержек)
      # ==========================================================
      live_candles_enabled: true          # Строим 1h/4h из базового интервала (обычно 15m)
      live_base_interval: "15m"           # Базовый ТФ, из которого агрегируем старшие
      live_prefer_agg: true               # Предпочитать агрегацию (15m→1h/4h) вместо чтения "родных" 1h/4h из БД
      live_extra_base_bars: 64            # Запас базовых баров при агрегации

      # ==========================================================
      # ✅ RISK / POSITION SIZE
      # ==========================================================
      risk_trade_pct: 2.0                 # Риск на сделку в % от equity (например 1.0 = 1% от капитала)
      risk_equity_usdt: 500               # Equity в USDT для расчёта риска; null => брать equity из БД
      risk_account_id: 1                  # account_id, из которого читать equity в БД (если risk_equity_usdt=null)

      # ==========================================================
      # ✅ STOP LOSS / TAKE PROFIT (ТОЛЬКО %)
      # ==========================================================
      stop_loss_pct: 2.0                  # SL в % от entry (например 2.0 = 2%)
      take_profit_mode: "pct"             # Режим TP (в проекте оставлен только percent-режим)
      take_profit_pct: 5.0                # TP в % от entry (например 6.0 = 6%)

      # Откуда брать цену входа (entry):
      #   "current"       -> текущая цена (ticker_24h.last_price, fallback close)
      #   "anchor_close"  -> close anchor-свечи (с крупной ликвидацией)
      #   "confirm_close" -> close свечи подтверждения (консервативный entry)
      entry_price_mode: "confirm_close"

      # ---------------------------
      # Уровни / Логика
      # ---------------------------
      period_levels: 240                  # Сколько свечей брать для поиска уровней S/R
      pivot_left: 4
      pivot_right: 4
      level_cluster_tol_pct: 0.003        # 0.003=0.3%: близкие уровни объединяются
      max_level_candidates: 14
      level_tol_pct: 0.0075               # Допуск касания уровня (±0.75%)

      # ==========================================================
      # ✅ TOUCH / CROSS
      # ==========================================================
      touch_lookback_candles: 5           # Сколько последних свечей проверять на касание/пробой уровня
      touch_mode: "touch_or_cross"        # "touch" | "cross" | "touch_or_cross"

      # ==========================================================
      # ✅ CONFIRMATION (убираем лаг на больших TF)
      # ==========================================================
      confirm_lookforward: 3              # Fallback: сколько свечей после anchor смотреть подтверждение направления

      confirm_lookforward_map:            # per-TF: confirm_lookforward
        "15m": 3
        "1h": 2
        "4h": 1

      # ==========================================================
      # ✅ Фильтр "рост объёма" относительно среднего ДО ликвидации
      # ==========================================================
      volume_avg_window: 240              # Окно ДО anchor для расчёта avg_volume

      # Требуемый рост объёма anchor относительно среднего (в %).
      # Маппинг по intervals:
      #   15m→25%  (volume_anchor >= avg_volume * 1.25)
      #   1h →45%  (volume_anchor >= avg_volume * 1.45)
      #   4h →90%  (volume_anchor >= avg_volume * 1.90)
      # 0 или <=0 => отключить объёмный фильтр для этого TF.
      volume_change_pct: [25, 45, 90]

      # ==========================================================
      # ✅ СВЕЖЕСТЬ СИГНАЛОВ (отбрасываем старые)
      # ==========================================================
      fresh_signal_minutes: 30            # Fallback: порог свежести (мин). 0/<=0 => отключить

      fresh_signal_minutes_map:
        "15m": 20
        "1h": 25
        "4h": 30
      # Примечание: свежесть считается по close-time: signal_ts + длительность интервала.

      # ---------------------------
      # Funding (опционально)
      # ---------------------------
      enable_funding: true
      kof_fund: 0.001                     # Порог funding (в %). 0.001% => 0.00001 (доля)

      # ---------------------------
      # ✅ Графики
      # ---------------------------
      enable_plots: true
      plots_dir: "artifacts/screener_plots"
      plots_keep_days: 2
      plots_cleanup_every_minutes: 60
      plot_lookback: 120
      plot_lookforward: 40
      plot_max_signals: 50                # Максимум графиков за прогон

      # ---------------------------
      # Дебаг
      # ---------------------------
      debug: true
      debug_top: 10

      # ✅ TELEGRAM
      telegram_enabled: true
      telegram_timezone: "Europe/Moscow"
      telegram_extras_enabled: true
      telegram_max_friends: 5

      telegram_send_text: false
      telegram_send_plots: true
      telegram_plot_mode: "photo"         # "photo" | "document"
      telegram_max_plot_signals: 50
      telegram_send_plot_followup_text: false
